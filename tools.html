<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>實用工具 - 2026 京都八日遊</title>    
    <!-- PWA Support -->
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#d4af37">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="鈭祇2026">
    <link rel="apple-touch-icon" href="icons/icon-192.png">
    <!-- 載入 Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }
        .route-card {
            background-color: white;
            padding: 1.5rem;
            border-radius: 1rem;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
            margin-bottom: 1.5rem;
        }
        .speak-btn:active {
            transform: scale(0.95);
        }
        /* 錄音中的動畫效果 */
        .listening-ring {
            box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7);
            animation: ring-pulse 1.5s infinite;
        }
        @keyframes ring-pulse {
            0% {
                transform: scale(0.95);
                box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7);
            }
            70% {
                transform: scale(1);
                box-shadow: 0 0 0 10px rgba(239, 68, 68, 0);
            }
            100% {
                transform: scale(0.95);
                box-shadow: 0 0 0 0 rgba(239, 68, 68, 0);
            }
        }
    </style>
</head>
<body class="p-0 sm:p-6">
    <!-- Navigation Bar -->
    <div class="sticky top-0 z-10 bg-white border-b border-gray-200 shadow-md mb-6 py-2 overflow-x-auto">
        <div class="flex space-x-2 px-4 whitespace-nowrap">
            <a href="itinerary.html" class="px-3 py-1 text-sm font-medium rounded-full text-gray-700 bg-gray-100 hover:bg-gray-200 transition duration-150">總覽</a>
            <!-- Active Link -->
            <a href="tools.html" class="px-3 py-1 text-sm font-semibold rounded-full bg-purple-600 text-white shadow-lg transition duration-150">實用工具</a>
            <a href="day_1_itinerary.html" class="px-3 py-1 text-sm font-medium rounded-full text-gray-700 bg-gray-100 hover:bg-gray-200 transition duration-150">Day 1</a>
            <a href="day_2_itinerary.html" class="px-3 py-1 text-sm font-medium rounded-full text-gray-700 bg-gray-100 hover:bg-gray-200 transition duration-150">Day 2</a>
            <a href="day_3_itinerary.html" class="px-3 py-1 text-sm font-medium rounded-full text-gray-700 bg-gray-100 hover:bg-gray-200 transition duration-150">Day 3</a>
            <a href="day_4_itinerary.html" class="px-3 py-1 text-sm font-medium rounded-full text-gray-700 bg-gray-100 hover:bg-gray-200 transition duration-150">Day 4</a>
            <a href="day_5_itinerary.html" class="px-3 py-1 text-sm font-medium rounded-full text-gray-700 bg-gray-100 hover:bg-gray-200 transition duration-150">Day 5</a>
            <a href="day_6_itinerary.html" class="px-3 py-1 text-sm font-medium rounded-full text-gray-700 bg-gray-100 hover:bg-gray-200 transition duration-150">Day 6</a>
            <a href="day_7_itinerary.html" class="px-3 py-1 text-sm font-medium rounded-full text-gray-700 bg-gray-100 hover:bg-gray-200 transition duration-150">Day 7</a>
            <a href="day_8_itinerary.html" class="px-3 py-1 text-sm font-medium rounded-full text-gray-700 bg-gray-100 hover:bg-gray-200 transition duration-150">Day 8</a>
        </div>
    </div>

    <!-- Main Container -->
    <div class="max-w-xl mx-auto px-4 sm:px-0">
        <header class="text-center mb-6">
            <h1 class="text-3xl font-bold text-gray-800 flex items-center justify-center">
                <span class="mr-2">🧰</span> 實用工具箱
            </h1>
            <h2 class="text-xl text-gray-600 mt-1">
                緊急應變與語言溝通
            </h2>
        </header>

        <!-- 1. 安全與緊急應變 -->
        <div class="route-card bg-red-100 border-t-4 border-red-600">
            <h3 class="text-2xl font-semibold text-red-800 mb-4 flex items-center">
                <span class="mr-2">🆘</span> 安全與緊急應變
            </h3>
            
            <div class="grid grid-cols-1 gap-4">
                <!-- 緊急聯絡卡 -->
                <div class="bg-white p-4 rounded-lg shadow border border-red-200">
                    <h4 class="text-lg font-bold text-gray-800 mb-3 border-b pb-1">📞 緊急聯絡電話</h4>
                    <ul class="space-y-3 text-gray-700">
                        <li class="flex items-center justify-between">
                            <span>👮 警察 (報案)</span>
                            <a href="tel:110" class="font-bold text-blue-600 bg-blue-50 px-3 py-1 rounded-full">110</a>
                        </li>
                        <li class="flex items-center justify-between">
                            <span>🚑 救護車/火警</span>
                            <a href="tel:119" class="font-bold text-red-600 bg-red-50 px-3 py-1 rounded-full">119</a>
                        </li>
                        <li class="flex items-center justify-between">
                            <span>🌊 海上保安廳</span>
                            <a href="tel:118" class="font-bold text-blue-600 bg-blue-50 px-3 py-1 rounded-full">118</a>
                        </li>
                    </ul>
                    <div class="mt-4 pt-3 border-t border-gray-100">
                        <p class="text-sm font-bold text-gray-800 mb-1">🇹🇼 台北駐大阪經濟文化辦事處</p>
                        <p class="text-xs text-gray-500 mb-1">急難救助電話 (專供緊急求助之用)</p>
                        <a href="tel:+81-90-8794-4568" class="block w-full text-center font-bold text-white bg-red-600 py-2 rounded-lg hover:bg-red-700 transition">
                            +81-90-8794-4568
                        </a>
                    </div>
                </div>

                <!-- 就醫指引 -->
                <div class="bg-white p-4 rounded-lg shadow border border-blue-200">
                    <h4 class="text-lg font-bold text-gray-800 mb-3 border-b pb-1">🏥 京都外語對應急診</h4>
                    <ul class="space-y-4 text-gray-700">
                        <li>
                            <p class="font-bold text-blue-800">京都大學醫學部附屬醫院</p>
                            <a href="https://maps.app.goo.gl/8jZ1Xy7z1y1z1z1z1" target="_blank" class="text-xs text-blue-500 hover:underline">📍 左京區聖護院川原町54</a>
                            <a href="tel:+81-75-751-3111" class="block text-sm font-bold text-gray-800 mt-1">📞 075-751-3111</a>
                        </li>
                        <li>
                            <p class="font-bold text-blue-800">京都第一赤十字醫院</p>
                            <a href="https://maps.app.goo.gl/8jZ1Xy7z1y1z1z1z1" target="_blank" class="text-xs text-blue-500 hover:underline">📍 東山區本町15-749</a>
                            <a href="tel:+81-75-561-1121" class="block text-sm font-bold text-gray-800 mt-1">📞 075-561-1121</a>
                        </li>
                    </ul>
                </div>
            </div>
        </div>

        <!-- 2. 實用旅遊日語指指通 (翻譯升級版) -->
        <div class="route-card bg-purple-50 border-t-4 border-purple-500">
            <h3 class="text-2xl font-semibold text-purple-800 mb-4 flex items-center">
                <span class="mr-2">🗣️</span> 日語指指通 (中日翻譯 + 語音)
            </h3>
            
            <!-- Translation Input Area -->
            <div class="mb-6 bg-white p-4 rounded-lg shadow border border-purple-200">
                <label for="custom-text" class="block text-sm font-bold text-gray-700 mb-2">✍️ 輸入或說出中文 (自動翻成日文)</label>
                
                <div class="flex space-x-2 mb-2">
                    <input type="text" id="custom-text" placeholder="例如：這附近有推薦的餐廳嗎？" class="flex-1 border border-gray-300 rounded-md px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-purple-500">
                    <!-- Mic Button -->
                    <button id="mic-btn" onclick="startListening()" class="bg-gray-200 text-gray-700 px-3 py-2 rounded-md hover:bg-gray-300 transition flex items-center justify-center" title="語音輸入">
                        <span class="text-xl">🎙️</span>
                    </button>
                </div>

                <!-- Translation Button -->
                <button onclick="handleTranslateAndSpeak()" class="w-full bg-purple-600 text-white px-4 py-2 rounded-md text-sm font-bold hover:bg-purple-700 transition mb-3 flex justify-center items-center">
                    <span class="mr-2">🔄</span> 翻譯並播放日語
                </button>

                <!-- Result Display -->
                <div id="translation-result" class="hidden bg-gray-50 rounded-md p-3 border border-gray-200">
                    <p class="text-xs text-gray-500 mb-1">翻譯結果 (日文)：</p>
                    <p id="translated-text" class="text-lg font-bold text-purple-800 mb-2">...</p>
                    <p class="text-xs text-gray-500 mb-1">原文 (中文)：</p>
                    <p id="original-text" class="text-sm text-gray-700">...</p>
                    
                    <div class="mt-3 flex justify-end">
                        <button onclick="speakTranslated()" class="bg-purple-100 text-purple-700 px-3 py-1 rounded text-xs font-bold hover:bg-purple-200 flex items-center">
                            <span class="mr-1">🔊</span> 再聽一次
                        </button>
                    </div>
                </div>
            </div>

            <div class="grid grid-cols-1 gap-3">
                <!-- Group: Basic -->
                <div class="space-y-2">
                    <h4 class="text-sm font-bold text-gray-500 uppercase border-b pb-1">基本用語</h4>
                    <button onclick="speak('ありがとうございます')" class="speak-btn w-full bg-white p-3 rounded-lg shadow flex justify-between items-center hover:bg-gray-50 border border-gray-200">
                        <div class="text-left">
                            <div class="text-lg font-bold text-gray-800">ありがとうございます</div>
                            <div class="text-xs text-gray-500 font-medium">Arigato gozaimasu (謝謝)</div>
                        </div>
                        <span class="text-2xl text-purple-500">🔊</span>
                    </button>
                    <button onclick="speak('すみません')" class="speak-btn w-full bg-white p-3 rounded-lg shadow flex justify-between items-center hover:bg-gray-50 border border-gray-200">
                        <div class="text-left">
                            <div class="text-lg font-bold text-gray-800">すみません</div>
                            <div class="text-xs text-gray-500 font-medium">Sumimasen (不好意思 / 請問)</div>
                        </div>
                        <span class="text-2xl text-purple-500">🔊</span>
                    </button>
                </div>

                <!-- Group: Dining -->
                <div class="space-y-2 mt-2">
                    <h4 class="text-sm font-bold text-gray-500 uppercase border-b pb-1">餐廳用餐</h4>
                    <button onclick="speak('これをください')" class="speak-btn w-full bg-white p-3 rounded-lg shadow flex justify-between items-center hover:bg-gray-50 border border-gray-200">
                        <div class="text-left">
                            <div class="text-lg font-bold text-gray-800">これをください</div>
                            <div class="text-xs text-gray-500 font-medium">Kore o kudasai (請給我這個)</div>
                        </div>
                        <span class="text-2xl text-purple-500">🔊</span>
                    </button>
                    <button onclick="speak('お水をください')" class="speak-btn w-full bg-white p-3 rounded-lg shadow flex justify-between items-center hover:bg-gray-50 border border-gray-200">
                        <div class="text-left">
                            <div class="text-lg font-bold text-gray-800">お水をください</div>
                            <div class="text-xs text-gray-500 font-medium">Omizu o kudasai (請給我冰水)</div>
                        </div>
                        <span class="text-2xl text-purple-500">🔊</span>
                    </button>
                    <button onclick="speak('お会計をお願いします')" class="speak-btn w-full bg-white p-3 rounded-lg shadow flex justify-between items-center hover:bg-gray-50 border border-gray-200">
                        <div class="text-left">
                            <div class="text-lg font-bold text-gray-800">お会計をお願いします</div>
                            <div class="text-xs text-gray-500 font-medium">Okaikei o onegaishimasu (請結帳)</div>
                        </div>
                        <span class="text-2xl text-purple-500">🔊</span>
                    </button>
                    <button onclick="speak('トイレはどこですか')" class="speak-btn w-full bg-white p-3 rounded-lg shadow flex justify-between items-center hover:bg-gray-50 border border-gray-200">
                        <div class="text-left">
                            <div class="text-lg font-bold text-gray-800">トイレはどこですか</div>
                            <div class="text-xs text-gray-500 font-medium">Toire wa doko desuka (請問廁所在哪裡？)</div>
                        </div>
                        <span class="text-2xl text-purple-500">🔊</span>
                    </button>
                    <button onclick="speak('ネギ抜きでお願いします')" class="speak-btn w-full bg-white p-3 rounded-lg shadow flex justify-between items-center hover:bg-gray-50 border border-gray-200">
                        <div class="text-left">
                            <div class="text-lg font-bold text-gray-800">ネギ抜きでお願いします</div>
                            <div class="text-xs text-gray-500 font-medium">Negi nuki de onegaishimasu (請不要加蔥)</div>
                        </div>
                        <span class="text-2xl text-purple-500">🔊</span>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        let jaMaleVoice = null;

        // --- Voice Loading Logic (Prioritize Male) ---
        function loadVoices() {
            const voices = window.speechSynthesis.getVoices();
            const jaVoices = voices.filter(v => v.lang.toLowerCase().includes('ja'));
            const maleKeywords = ['otoya', 'ichiro', 'takumi', 'hattori', 'male', 'men'];
            
            jaMaleVoice = jaVoices.find(voice => {
                const name = voice.name.toLowerCase();
                return maleKeywords.some(k => name.includes(k));
            });
        }

        if ('speechSynthesis' in window) {
            window.speechSynthesis.onvoiceschanged = loadVoices;
            loadVoices();
        }

        // --- Text-to-Speech Function ---
        function speak(text) {
            if ('speechSynthesis' in window) {
                window.speechSynthesis.cancel();
                
                const utterance = new SpeechSynthesisUtterance(text);
                utterance.lang = 'ja-JP';
                utterance.rate = 0.9;

                if (!jaMaleVoice) loadVoices();
                if (jaMaleVoice) {
                    utterance.voice = jaMaleVoice;
                }

                window.speechSynthesis.speak(utterance);
            } else {
                alert('您的瀏覽器不支援語音播放功能。');
            }
        }

        // --- Translation & Speech Recognition Logic ---
        let currentTranslatedText = "";

        // 1. Speech Recognition (Web Speech API)
        function startListening() {
            if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) {
                alert('您的瀏覽器不支援語音辨識功能 (請使用 Chrome 或 Safari)。');
                return;
            }

            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            const recognition = new SpeechRecognition();
            
            recognition.lang = 'zh-TW'; // 設定輸入語言為繁體中文
            recognition.interimResults = false;
            recognition.maxAlternatives = 1;

            const micBtn = document.getElementById('mic-btn');
            const inputField = document.getElementById('custom-text');

            recognition.onstart = function() {
                micBtn.classList.add('listening-ring', 'bg-red-100', 'text-red-600');
                inputField.placeholder = "請說話...";
            };

            recognition.onend = function() {
                micBtn.classList.remove('listening-ring', 'bg-red-100', 'text-red-600');
                inputField.placeholder = "例如：這附近有推薦的餐廳嗎？";
            };

            recognition.onresult = function(event) {
                const transcript = event.results[0][0].transcript;
                inputField.value = transcript;
                // 自動觸發翻譯
                handleTranslateAndSpeak();
            };

            recognition.onerror = function(event) {
                console.error('Speech recognition error', event.error);
                alert('無法辨識語音，請重試或檢查麥克風權限。');
            };

            recognition.start();
        }

        // 2. Translation Function (Using Google Translate unofficial API)
        async function handleTranslateAndSpeak() {
            const inputText = document.getElementById('custom-text').value;
            if (!inputText.trim()) {
                alert('請先輸入或說出要翻譯的中文。');
                return;
            }

            // 顯示載入中狀態
            const resultDiv = document.getElementById('translation-result');
            const translatedTextEl = document.getElementById('translated-text');
            const originalTextEl = document.getElementById('original-text');
            
            resultDiv.classList.remove('hidden');
            translatedTextEl.textContent = "翻譯中...";
            originalTextEl.textContent = inputText;

            try {
                // 使用公開的 Google Translate API 接口 (透過 CORS Proxy)
                const apiUrl = `https://translate.googleapis.com/translate_a/single?client=gtx&sl=zh-TW&tl=ja&dt=t&q=${encodeURIComponent(inputText)}`;
                // 注意：直接呼叫可能會遇到 CORS 問題，這裡使用 corsproxy.io
                const proxyUrl = `https://corsproxy.io/?${encodeURIComponent(apiUrl)}`;

                const response = await fetch(proxyUrl);
                if (!response.ok) throw new Error('Translation API Error');
                
                const data = await response.json();
                // Google Translate API 回傳結構: [[["日文結果", "中文原文", ...]], ...]
                const translatedText = data[0][0][0];

                // 更新 UI
                currentTranslatedText = translatedText;
                translatedTextEl.textContent = currentTranslatedText;
                
                // 自動播放語音
                speak(currentTranslatedText);

            } catch (error) {
                console.error('Translation failed:', error);
                translatedTextEl.textContent = "翻譯失敗，請稍後再試或手動輸入。";
                // Fallback: 如果翻譯失敗，嘗試直接朗讀輸入的文字(假設使用者輸入了日文)
                currentTranslatedText = inputText;
            }
        }

        function speakTranslated() {
            if (currentTranslatedText) {
                speak(currentTranslatedText);
            }
        }

        function speakCustom() {
            // 保留舊有功能，直接播放輸入框內容
            const text = document.getElementById('custom-text').value;
            if (text.trim() !== "") {
                speak(text);
            }
        }
    </script>

    <!-- Service Worker Registration -->
    <script>
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/service-worker.js')
                    .then((registration) => console.log('??SW registered'))
                    .catch((error) => console.log('??SW registration failed:', error));
            });
        }
    </script>
</body>
</html>